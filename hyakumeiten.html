<!DOCTYPE html>
<html lang="ja">
<head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-71149531-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-71149531-1');
</script>
<meta charset="utf-8">
<meta name="Description" content="えきぎめ：メンバーの集合駅を提案するサービスです。中間駅、オススメ駅の機能を提供中。">
<meta name="Keywords" content="えきぎめ,エキギメ,駅,中間駅,百名店,イベント,幹事">
<!-- Bootstrap -->
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
<link rel="shortcut icon" type="image/png" href="/img/favicon.png" />
<title>えきぎめ - 百名店検索</title>
<!-- Google Adsense -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9821400023592854" crossorigin="anonymous"></script>
</head>
<body>
<div class="container">
<header class="d-flex justify-content-center py-3 align-items-center">
  <ul class="nav nav-pills">
    <li class="nav-item align-self-center"><a href="/" class="nav-link"><img src="/img/logo.svg" alt="えきぎめ" width="64px" height="30px"></a></li>
    <li class="nav-item align-self-center"><a href="/ekigime.html" class="nav-link">中間駅検索</a></li>
    <li class="nav-item align-self-center"><a href="/hyakumeiten.html" class="nav-link active" aria-current="page">百名店検索</a></li>
  </ul>
</header>
<script type="module">
import { get_min_all_json, get_eki_all_json, hyakumeiten_json, default as init } from './pkg/ekigime.js'

(async function () {
    await init();
    window.get_min_all_obj = function (eki_id) {
        return JSON.parse(get_min_all_json(eki_id));
    };
    window.hyakumeiten = JSON.parse(hyakumeiten_json());
    window.eki_id = JSON.parse(get_eki_all_json());
    window.id_eki = {};
    for (let eki in eki_id) {
        window.id_eki[eki_id[eki]] = eki;
    }

    // auto complete / suggest 用に datalist を追加
    let datalist = document.createElement('datalist');
    datalist.id = "ekilist";
    for (let eki of Object.keys(eki_id).sort()) {
        if (eki == "DUMMY") {
            continue;
        }
        let option = document.createElement('option');
        option.innerText = eki;
        datalist.appendChild(option);
    }
    document.body.appendChild(datalist);
})();
window.checkchange = function (event) {
    let element = event.target;
    let category = element.value;
    let elements = document.getElementsByClassName(category);
    if (element.checked) {
        element.parentNode.style.background = "#dadada";
        for (let e of elements) {
            e.style.display = "block";
        }
    } else {
        element.parentNode.style.background = "#ffffff";
        for (let e of elements) {
            e.style.display = "none";
        }
    }
    //console.log(event.target);
};
window.allchange = function (display) {
    let checks = document.getElementsByClassName("check");
    for (let c of checks) {
        c.parentNode.style.background = display ? "#dadada" : "#ffffff";
        c.checked = display;
    }
    let elements = document.getElementsByClassName("食べログ");
    for (let e of elements) {
        e.style.display = display ? "block" : "none";
    }
};

window.i = 0;
window.loading = function () {
    // ローディングボタン表示
    document.getElementById("hyoujibutton").disabled = true;
    document.getElementById("hyoujimoji").innerText = "計算しています…" + (window.i++ ? "" : "(初回は1分ほどかかります！)");
    document.getElementById("hyoujispinner").style.display = ""
};

window.stoploading = function () {
    // ローディングボタン非表示
    document.getElementById("hyoujispinner").style.display = "none"
    document.getElementById("hyoujibutton").disabled = false;
    document.getElementById("hyoujimoji").innerText = "表示する";
};

window.hyouji = function () {
    if (!window.get_min_all_obj || !window.eki_id) {
        // ローディングボタン非表示
        window.stoploading();
        return;
    }

    // 駅順
    let element = document.getElementById('eki');
    if (!element || !element.value || !eki_id[element.value]) {
        // ローディングボタン非表示
        window.stoploading();
        return;
    }
    let min_all = get_min_all_obj(eki_id[element.value]);

    let result = Object.keys(eki_id).map(function (eki) {
        return [ eki, parseInt(min_all[eki_id[eki]]), hyakumeiten[eki_id[eki]] ];
    });
    //console.log(result);

    // 百名店があった駅だけ表示する
    result = result.filter(function (record) {
        return record[2] && record[1] != 9999;
    }).sort(function (a, b) {
        if (a[1] > b[1]) {
            return 1;
        } else if (a[1] < b[1]) {
            return -1;
        } else {
            return 0;
        }
    });
    //console.log(result);

    let result_ele = document.getElementById('result');
    let category_list = {};
    let output = '<table class="hyakumeiten">' + result.map(function (record) {
        return '<tr><td>' + record[0]  + '</td><td>' + record[1]  + '</td><td class="shop">' + Object.keys(record[2]).sort().map(function (name) {
            let category = name.split(':')[0];
            category_list[category] = 1;
            return '<p class="' + category + '"><a target="_blank" href="' + record[2][name] + '">' + name + '</a></p>';
        }).join('') + '</td></tr>';
    }).join('') + '</table>';

    result_ele.innerHTML = '<input onclick="allchange(1)" type="button" value="全てチェック">'
    + '<input onclick="allchange(0)" type="button" value="全て外す">'
    + Object.keys(category_list).sort().map(function (category) {
        return '<label><input checked="checked" class="check" onchange="checkchange(arguments[0])" type="checkbox" value="' + category + '">' + category + '</label>';
    }).join('') + output;

    // ローディングボタン非表示
    window.stoploading();
};
</script>

<main>
<input id="eki" value="" list="ekilist" />

<button id="hyoujibutton" onclick="loading(); setTimeout('hyouji()', 10)">
<span id="hyoujispinner" style="display:none" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
<span id="hyoujimoji">表示する！</span>
</button>

<div id="result"></div>
</main>

<footer class="d-flex justify-content-center">
<div>© SMB 2023</div>
</footer>
</div>

<!-- Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
<!-- for table css -->
<link href="/style.css" rel="stylesheet">
</body>
</html>
